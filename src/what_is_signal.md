---
title: 'シグナル処理ことはじめ'
date: '2021-10-28'
description: ''
keywords:
  - Signal
  - Daemon
---

HTTP サーバみたいにずっと動きっぱなしのプログラムを
[デーモン](https://ja.wikipedia.org/wiki/%E3%83%87%E3%83%BC%E3%83%A2%E3%83%B3)
とか呼んでた時代もありましたが、最近は聞かない気がします。

とはいえ、Go や Rust の人気も出てきた昨今、割とデーモンになるようなプログラムを書く機会も増えているのではないかと感じています。
例えば、[JSON](https://www.json.org/json-ja.html) を [HTTP](https://datatracker.ietf.org/doc/html/rfc7230) でやり取りするようなサーバアプリケーションや、
[gRPC](https://grpc.io/) サーバアプリケーションを書いた場合には、基本的には動かしっぱなしのデーモンとしてアプリケーションを作るのが一般的です。

そんなプログラムを書くときに大事になってくる要素の一つがシグナル処理です。

あなたのプログラムは起動した後、任意のタイミングでうまく停止できる必要があります。
一般的には、アプリケーションは停止シグナルを受け取ったら停止するように作ります。
具体的には起動後に `Ctrl + C` を入力されたり、 OS から [kill コマンド](https://linuxjm.osdn.jp/html/LDP_man-pages/man2/kill.2.html) で停止をリクエストされたりした時に
アプリケーションはシグナルを OS から受け取りますので、受け取ったシグナルに応じた停止処理を作るのが良いでしょう。

本文書では、きちんと停止処理を書くために、改めてシグナル処理について振り返ってみます。

# シグナルってなんだっけ

一般的に、動いているプログラムをプロセスと呼び、このプロセスはたまに OS から割り込みを受けます。
この割り込みが「シグナル」です。

例えば、あなたが `httpd` サーバを動かしている最中に、誰かがそのマシンの電源ボタンを押してシャットダウンを開始したとしたら
`httpd` サーバには `SIGHUP` というシグナルが OS から送られます。

他にも、起動中にあなたが `kill your_server` みたいにプロセスを終了させたり、`Ctrl + C` で終了を試みたりした場合も、
OS はプロセスに対して `SIGINT` というシグナルを送ります。

あなたがサーバを書くときに、シグナルを処理しなくても、最終的には OS によってプロセスは終了させられることにはなると思いますが、
きちんと処理した方がスマートです。
(何がどうスマートかというと、終了時の処理をきちんと書いてあるあたりがスマートです)

そんなわけで、世界中の大抵のサーバプログラムでは、シグナル制御がきちんと書かれています。
例えば、 Ruby on Rails の `rails` コマンドで
[SIGINT を処理しているのはこの辺](https://github.com/rails/rails/blob/v6.0.0/railties/lib/rails/cli.rb#L10)
です。

## シグナルの種類

シグナルは OS によって定義されており、OS によってまちまちです。
とはいえ、ある程度は共通化されており、大体の OS が従っている [POSIX のシグナル](https://en.wikipedia.org/wiki/Signal_(IPC)#POSIX_signals) には 30 強のシグナルが定義されています。
このうち、デーモンになるプログラムを書く際に、よく使うのは２−３種類です。

この、一般的な業務アプリを書くサーバプログラマーがよく出会う２-３種類を順に上げていくと以下の通りとなります。

* SIGINT (割り込み, interrupt): 端末、つまりターミナルとかから割り込みキー (通常は `Ctrl + C`) が押されたときに発生するシグナル
* SIGTERM (終了, terminate): 誰かが kill コマンド実行するとかによりプロセスを終了するよう OS が判断したときに発生するシグナル
* SIGHUP (停止, hang-up): 端末が閉じられた時とかに発生するシグナル。例えば、無限ループするプログラムを実行中とかに、ターミナルを閉じたりするとこのシグナルが発生し、無限ループ中のプログラムは終了する。

自分でシグナル処理をアプリケーションに書くのが `SIGINT`, `SIGTERM` あたりで、 `SIGHUP` は、どちらかというと `SIGHUP` が発生しないように `nohup` コマンドを使うときに出くわすことが多い印象です。

その他にも、セグメンテーション違反が起きたときの `SIGSEGV` や、`Ctrl + Z` 押したときの `SIGSTP` などもありますが、あまり自分で処理するプログラムを書くことはない印象です。

その他のシグナルについては、 [wikipedia](https://ja.wikipedia.org/wiki/%E3%82%B7%E3%82%B0%E3%83%8A%E3%83%AB_(Unix)) を読むのが一番わかりやすいと思います。

# 各言語でのシグナル制御

各言語でのシグナル処理の実装例を見ていこう。
それぞれ無限ループしながら１秒に１ずつカウントを標準出力に書き、 `Ctrl + C` を受け取ったら "bye" と書いて終了するプログラムだ。

## Go


## C

c_signal

## Ruby

ruby_signal

## Java

java_signal
