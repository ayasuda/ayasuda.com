<!DOCTYPE html>
<html lang="ja" dir="ltr">
<head>
  <meta charset="utf-8">
  <base href="https://ayasuda.github.io/">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Atsushi Yasuda">
  <meta name="description" content="rails new するとできる bin ディレクトリの役割と、それぞれの内容についてメモ程度にまとめてみました。">
  <meta name="keywords" content="rails, script, binstub">
  <meta name="date" content="2017-11-06">
  <title>rails new するとできる bin ディレクトリまとめ</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="/css/style.css">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-138223597-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-138223597-1');
  </script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header class="site">
  <h1><a href="/">ayasuda.github.io</a></h1>
</header>
<article>
  <header class="content">
    <h1>rails new するとできる bin ディレクトリまとめ</h1>
    <div class="published">2017-11-06</div>
    <p>rails new するとできる bin ディレクトリの役割と、それぞれの内容についてメモ程度にまとめてみました。</p>
    <ul class="keywords">
      <li>rails</li>
      <li>script</li>
      <li>binstub</li>
    </ul>
  </header>
<h1 id="rails-の各種コマンドは-bin-ディレクトリから">Rails の各種コマンドは bin ディレクトリから</h1>
<p><code>rails new APP</code> すると出来上がる rails プロジェクトでは、 ルートディレクトリに <code>bin</code> ディレクトリが生成されます。</p>
<p>この中には、サーバを起動したり、テストをしたり、アプリケションを管理する 様々なスクリプトファイルが置かれます。</p>
<pre><code>$ ls bin
bundle  rails   rake    setup   spring  update  yarn</code></pre>
<p>この文書では、これらのコマンドそれぞれの役割についてまとめてみたいと思います。</p>
<h2 id="そもそも論の-binstub">そもそも論の binstub</h2>
<p>詳しくは <a href="https://github.com/rbenv/rbenv/wiki/Understanding-binstubs">rbenv/rbenv/wiki/Understanding-binstubs</a> を 見るのが良いでしょう。</p>
<p>binstub は実行可能なラッパースクリプトです。</p>
<p>複数の Rails プロジェクトをメンテナンスしていたり、その他の ruby プロジェクトを行き来していると 例えば、それぞれのプロジェクトで <code>rspec</code> のバージョンが違ったりして、システムにインストールした <code>rspec</code> をそのまま使うのが辛いシチュなどがざらにあります。</p>
<p>そこで登場するのが binstub で、要するに、プロジェクトごとに <code>bin/rspec</code> みたいなラッパースクリプトを用意して ラッパーの中で必要な環境を整えてから、<code>rspec</code> を起動させようとします。</p>
<p>例えば、 Rails 4.2.8 で作ったプロジェクト foo と Rails 5.1.4 で作ったプロジェクト bar がある時、 binstub 経由でそれぞれのバージョンを確認すると、次のようにいい感じにバージョンが表示されるのがわかるかと思います。</p>
<pre><code>$ cd path/to/foo
$ ./bin/rails --version
Rails 4.2.8
$ cd path/to/bar
$ ./bin/rails --version
Rails 5.1.4</code></pre>
<p>そんなわけで、 Rails プロジェクトでは binstub がデフォルトで作成されています。</p>
<h2 id="bundle-rails-rake-spring-yarn">bundle, rails, rake, spring, yarn</h2>
<p>説明不要ですね。</p>
<p>それぞれ</p>
<ul>
<li><a href="http://bundler.io/">bundler</a></li>
<li><a href="http://rubyonrails.org/">rails</a></li>
<li><a href="https://github.com/ruby/rake">rake</a></li>
<li><a href="https://github.com/rails/spring">spring</a></li>
<li><a href="https://yarnpkg.com/ja/">yarn</a></li>
</ul>
<p>の binstub です。</p>
<h2 id="setup">setup</h2>
<p>Rails が用意する、「アプリケーションを初期化するスクリプト」です。</p>
<p><a href="https://github.com/rails/rails/pull/15189">プルリクエスト</a> を見れば意図は明白ですが、 ある Rails プロジェクトをコピー・クローン・チェックアウトなどした後のセットアップをこのスクリプトに納めさせしむものです。</p>
<p>ですので、このスクリプトをきちんと書くことで、例えばこの２コマンドで rails プロジェクトの初期化ができるようになります。</p>
<pre><code>$ git clone path/to/your/rails/project
$ cd project
$ bin/setup
# bundle install
# rake db:setup
# other steps...</code></pre>
<p>実際のところは、デフォルトで最小限のセットアップ構成が書かれているだけです。</p>
<p>短いので以下にファイルを転載します。ご覧の通り、本当に最小限のスクリプトです。 このスクリプトをメンテナンスすることで、プロジェクトに新しいメンバーがアサインされた際などの手間が省けます。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">#!/usr/bin/env ruby</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>require <span class="st">&#39;pathname&#39;</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>require <span class="st">&#39;fileutils&#39;</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>include <span class="dt">FileUtils</span></span>
<span id="cb4-5"><a href="#cb4-5"></a></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co"># アプリケーションのルートパス</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="dt">APP_ROOT</span> = <span class="dt">Pathname</span>.new <span class="dt">File</span>.expand_path(<span class="st">&#39;../../&#39;</span>, <span class="dv">__FILE__</span>)</span>
<span id="cb4-8"><a href="#cb4-8"></a></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="kw">def</span> system!(*args)</span>
<span id="cb4-10"><a href="#cb4-10"></a>  system(*args) || abort(<span class="st">&quot;\n== Command </span><span class="ot">#{</span>args<span class="ot">}</span><span class="st"> failed ==&quot;</span>)</span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="kw">end</span></span>
<span id="cb4-12"><a href="#cb4-12"></a></span>
<span id="cb4-13"><a href="#cb4-13"></a>chdir <span class="dt">APP_ROOT</span> <span class="kw">do</span></span>
<span id="cb4-14"><a href="#cb4-14"></a>  <span class="co"># このスクリプトはアプリケーションのセットアップの第一ステップとなります。</span></span>
<span id="cb4-15"><a href="#cb4-15"></a>  <span class="co"># ですので、必要なステップをこのファイルに追加していってください</span></span>
<span id="cb4-16"><a href="#cb4-16"></a></span>
<span id="cb4-17"><a href="#cb4-17"></a>  puts <span class="st">&#39;== Installing dependencies ==&#39;</span></span>
<span id="cb4-18"><a href="#cb4-18"></a>  system! <span class="st">&#39;gem install bundler --conservative&#39;</span></span>
<span id="cb4-19"><a href="#cb4-19"></a>  system(<span class="st">&#39;bundle check&#39;</span>) || system!(<span class="st">&#39;bundle install&#39;</span>)</span>
<span id="cb4-20"><a href="#cb4-20"></a></span>
<span id="cb4-21"><a href="#cb4-21"></a>  <span class="co"># JavaScript の依存ライブラリを yarn を使ってインストールします</span></span>
<span id="cb4-22"><a href="#cb4-22"></a>  <span class="co"># system(&#39;bin/yarn&#39;)</span></span>
<span id="cb4-23"><a href="#cb4-23"></a></span>
<span id="cb4-24"><a href="#cb4-24"></a></span>
<span id="cb4-25"><a href="#cb4-25"></a>  <span class="co"># puts &quot;\n== Copying sample files ==&quot;</span></span>
<span id="cb4-26"><a href="#cb4-26"></a>  <span class="co"># unless File.exist?(&#39;config/database.yml&#39;)</span></span>
<span id="cb4-27"><a href="#cb4-27"></a>  <span class="co">#   cp &#39;config/database.yml.sample&#39;, &#39;config/database.yml&#39;</span></span>
<span id="cb4-28"><a href="#cb4-28"></a>  <span class="co"># end</span></span>
<span id="cb4-29"><a href="#cb4-29"></a></span>
<span id="cb4-30"><a href="#cb4-30"></a>  puts <span class="st">&quot;\n== Preparing database ==&quot;</span></span>
<span id="cb4-31"><a href="#cb4-31"></a>  system! <span class="st">&#39;bin/rails db:setup&#39;</span></span>
<span id="cb4-32"><a href="#cb4-32"></a></span>
<span id="cb4-33"><a href="#cb4-33"></a>  puts <span class="st">&quot;\n== Removing old logs and tempfiles ==&quot;</span></span>
<span id="cb4-34"><a href="#cb4-34"></a>  system! <span class="st">&#39;bin/rails log:clear tmp:clear&#39;</span></span>
<span id="cb4-35"><a href="#cb4-35"></a></span>
<span id="cb4-36"><a href="#cb4-36"></a>  puts <span class="st">&quot;\n== Restarting application server ==&quot;</span></span>
<span id="cb4-37"><a href="#cb4-37"></a>  system! <span class="st">&#39;bin/rails restart&#39;</span></span>
<span id="cb4-38"><a href="#cb4-38"></a><span class="kw">end</span></span></code></pre></div>
<h2 id="update">update</h2>
<p>Rails が用意する、「アプリケーションを更新するスクリプト」です。</p>
<p><a href="https://github.com/rails/rails/pull/20972">プルリクエスト</a> を見れば意図は明白ですが、 ある Rails プロジェクトを更新、例えば <code>git pull origin</code> した後などに、変更されたすべてを更新させるスクリプトです。</p>
<p>ですので、このスクリプトをきちんと書くことで、例えばこの２コマンドで rails プロジェクトの更新ができるようになります。</p>
<pre><code>$ git pull origin master
$ bin/update
# gem の更新
# rake db:migrate
# ログの更新
# rails のリスタート</code></pre>
<p>このスクリプトも setup と同じく大変短いスクリプトです。 面倒臭がらずにきちんとメンテナンスすることで、チーム開発に <em>大変役立ちます</em> ので、ぜひ運用してください。</p>
<h2 id="scripts-to-rule-them-all">Scripts To Rule Them All</h2>
<p>セットアップ方法や更新方法を１スクリプトにまとめようというのは、様々なプロジェクトでよく見られる光景です。 しかしながら、どのようなスクリプトを用意すれば良いかについては、往々にして必要になってから考案されます。</p>
<p>GitHub 社が社内で用意している、プロジェクト管理用のスクリプトと運用方法についてまとめたのが <a href="https://githubengineering.com/scripts-to-rule-them-all/">Scripts to Rule Them All | GitHub Engineering</a> です。</p>
<p>GitHub社でも社内で様々なプロジェクトを開発しているようで、それらのプロジェクトを <code>git clone</code> してから 開発環境で立ち上げ、そして各種作業をするためのコマンドを統一することでエンジニアの負荷を下げています。</p>
<p>大抵のプロジェクトでは、エンジニアは次の４つのタスクを必ず行います。</p>
<ul>
<li>開発環境の立ち上げ</li>
<li>テストの実行</li>
<li>CI の実行</li>
<li>アプリの起動</li>
</ul>
<p>GitHub社ではこれらの作業を標準化するために、すべてのプロジェクトで同じコマンドを用意しています。 これが「Script to Rule Tehm All」とのことです。</p>
<p>さて、彼らは具体的には７つのスクリプトを用いています。</p>
<ul>
<li><code>script/bootstrap</code> : すべての依存ライブラリをインストール・更新する</li>
<li><code>script/setup</code> : プロジェクトをセットアップする（クローン直後に使用する）</li>
<li><code>script/update</code> : プロジェクトを更新する</li>
<li><code>script/server</code> : アプリをスタートする</li>
<li><code>script/test</code> : すべてのテストを実行する</li>
<li><code>script/cibuild</code> : CI サーバが実行し、すべてのテストを実行する</li>
<li><code>script/console</code> : コンソールを開く</li>
</ul>
<p>このようなスクリプトをきちんと用意すれば、初めてアサインされたプロジェクトでも すぐにアプリを立ち上げられ、テストを動かせ、そしてコンソールでデータの操作ができます。</p>
<p>GitHub 社はこのパターンについての指針などをまとめたリポジトリを <a href="https://github.com/github/scripts-to-rule-them-all">github/scripts-to-rule-them-all</a> として 公開していますので、是非ご覧になってください。</p>
<p><a href="https://github.com/rails/rails/pull/20972">bin/update を追加したプルリクエスト</a> を見れば意図は明白ですが、</p>
<h2 id="なんで-script-ディレクトリじゃないの">なんで script ディレクトリじゃないの？</h2>
<p><code>script/</code> が廃止され、<code>bin/</code> が導入されたのは Rails 4.0 からです。</p>
<p>実際に導入された <a href="https://github.com/rails/rails/pull/8786">プルリクエスト</a> を見るとわかりますが、 binstub に合わせた為です。</p>
<h2 id="direnv-使って楽するといいと思うよ">direnv 使って楽するといいと思うよ</h2>
<p>binstub のお供に最適なのが <a href="https://direnv.net/">direnv</a> です。</p>
<p>このツールはとても単純で、「特定のディレクトリに cd すると、設定された profile を読み込む」というツールなのですが、</p>
<p>このツールを使って、 PATH に <code>RAILS_ROOT/bin</code> を追加することで、例えば、 <code>rails</code> コマンドや <code>bundle</code> コマンドを自然に使えるようになります。</p>
</article>
<footer>
  <ul>
    <li><a href="/">Archive</a></li>
  </ul>
</footer>
</body>
</html>
