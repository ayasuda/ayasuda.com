<!DOCTYPE html>
<html lang="ja" dir="ltr">
<head>
  <meta charset="utf-8">
  <base href="https://ayasuda.github.io/">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Cache-Control" content="no-cache">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Atsushi Yasuda">
  <meta name="description" content="Go 言語でシグナルを受け取り、適宜処理する方法についてサンプルコードともにまとめました">
  <meta name="keywords" content="Signal, Go, シグナル, シグナル処理, Go言語">
  <meta name="date" content="2021-10-12">
  <title>Go 言語でのシグナル処理</title>
  <link rel="stylesheet" href="/css/style.css">
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-138223597-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-138223597-1');
  </script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header class="site-header">
  <h1><a href="/">ayasuda.github.io</a></h1>
</header>
<article class="content">
  <header>
    <h1>Go 言語でのシグナル処理</h1>
    <div class="content-meta">
    <div class="published">2021-10-12</div>
      <ul class="keywords">
        <li><a href="/pages/tags/Go.html">Go</a></li>
      </ul>
      <p>Go 言語でシグナルを受け取り、適宜処理する方法についてサンプルコードともにまとめました</p>
    </div>
  </header>
  <nav id="TOC">
  <ul>
  <li><a href="#サンプルコード">サンプルコード</a>
  <ul>
  <li><a href="#signal-型">Signal 型</a></li>
  <li><a href="#syscall-パッケージの定数">syscall パッケージの定数</a></li>
  <li><a href="#notify-関数">Notify 関数</a></li>
  </ul></li>
  <li><a href="#os.signal-パッケージ">os.Signal パッケージ</a>
  <ul>
  <li><a href="#ignore">Ignore</a></li>
  <li><a href="#ignored">Ignored</a></li>
  <li><a href="#notifycontext">NotifyContext</a></li>
  <li><a href="#reset">Reset</a></li>
  <li><a href="#stop">Stop</a></li>
  </ul></li>
  </ul>
  </nav>
<p>Go 1.17.1 にて検証済みです</p>
<p>シグナル処理とは何か？　については <a href="/pages/what_is_signal.html">シグナル処理ことはじめ</a> にてまとめました。 ここでは、 Go 言語でシグナル処理をどのようにやるのかについてまとめていきます。</p>
<p>まずはサンプルコードをベースに基本的な機能を紹介します。 次に、使用しているパッケージの詳細な説明をしていこうと思います。</p>
<h1 id="サンプルコード">サンプルコード</h1>
<p>無限ループしながら１秒に１ずつカウントを標準出力に書き、 <code>Ctrl + C</code> を受け取ったら “bye” と書いて終了するプログラムをもとに解説していきます。 サンプルコードは <a href="https://github.com/ayasuda/sandbox/blob/master/go/signal/basic/main.go">github</a> にアップロード済みです。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;fmt&quot;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;os&quot;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;os/signal&quot;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;time&quot;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 1 秒に 1 回起動する ticker を作成する</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 具体的には Ticker.C という chan Time なチャンネルに指定間隔で変数が投げられるようになります</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    ticker <span class="op">:=</span> time<span class="op">.</span>NewTicker<span class="op">(</span><span class="dv">1</span> <span class="op">*</span> time<span class="op">.</span>Second<span class="op">)</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 終了処理用に bool 型のチャンネルを用意する</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    done <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">bool</span><span class="op">,</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// シグナル受信用のチャンネルを用意する</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    sigs <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> os<span class="op">.</span>Signal<span class="op">,</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// プログラムがシグナルを受信した際に、チャンネルに通知するように設定する</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 具体的には `os.Interrupt` (SIGINT のこと) をプログラムが受信したら</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// sigs 変数のチャンネルに通知するように設定しています</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    signal<span class="op">.</span>Notify<span class="op">(</span>sigs<span class="op">,</span> os<span class="op">.</span>Interrupt<span class="op">)</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    cnt <span class="op">:=</span> <span class="dv">0</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 以下の関数を、goroutine として非同期に実行開始する</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> <span class="op">{</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>            <span class="co">// ticker.C チャンネルに何か来るまで for ループを止める</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>            <span class="co">// ticker のところでも解説しましたが、1 秒に1回、Time 型の変数が投げられます</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;-</span>ticker<span class="op">.</span>C</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>            cnt <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>            fmt<span class="op">.</span>Println<span class="op">(</span>cnt<span class="op">)</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 以下の関数を、goroutine として非同期に実行開始する</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">// sigs チャンネルに何かが来るまで goroutine を止める</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;-</span>sigs</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 標準出力に &quot;bye&quot; と表示する</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>        fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;bye&quot;</span><span class="op">)</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 後始末として ticker を止める</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>        ticker<span class="op">.</span>Stop<span class="op">()</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">// done チャンネルに true を投げる</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>        done <span class="op">&lt;-</span> <span class="ot">true</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">// done チャンネルに何かが来るまでプログラムを止める</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;-</span>done</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>以下のコマンドでこのコードは実行可能です。</p>
<pre><code>$ go run main.go</code></pre>
<p>コードを実行すると、１秒毎に数字をカウントアップし続けます。 終了したい場合は <code>Ctrl + C</code> を入力します。</p>
<h2 id="signal-型">Signal 型</h2>
<p>公式ドキュメントは https://pkg.go.dev/os@go1.17.1#Signal にあります。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Signal <span class="kw">interface</span> <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    String<span class="op">()</span> <span class="dt">string</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    Signal<span class="op">()</span> <span class="co">// 他の Stringer な interface と区別するためのダミー用定義なので使わない</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>os</code> パッケージの <code>Signal</code> 型は OS からのシグナルを表します。 実際の実装は OS 毎に異なり、特に Unix 系の OS は <code>syscall</code> パッケージの <code>Singal</code> に定数が定義されています。</p>
<p><code>os</code> パッケージに直接定義されているシグナルは以下の２つです。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="op">(</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    Interrupt Signal <span class="op">=</span> syscall<span class="op">.</span>SIGINT</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    Kill Signal      <span class="op">=</span> syscall<span class="op">.</span>SIGKILL</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span></code></pre></div>
<p>この２つのシグナルはすべての OS で使用可能です。</p>
<h2 id="syscall-パッケージの定数">syscall パッケージの定数</h2>
<p>公式ドキュメントは https://pkg.go.dev/syscall#SIGABRT にあります。</p>
<p>各種シグナル用の定数が用意されており、上記で示した <code>Signal</code> として利用可能です。 ただし、このパッケージを直接使うよりも、より抽象化した <code>os</code> や <code>time</code>, <code>net</code> パッケージなどを使うようにしたほうが良いです。</p>
<p>このパッケージ自体は、現在ロックダウン中で、各種 OS に特化したシステム依存の定数などは <code>golang.org/x/sys</code> パケージを利用するようにしてください。</p>
<p>こうなった背景は以下を参照すると良いでしょう</p>
<ul>
<li>https://golang.org/s/go1.4-syscall</li>
<li><a href="https://qiita.com/sonatard/items/f03883ac061cf9fe4718">Go Binary Hacks - syscallとgolang.org/x/sys/ #golang - Qiita</a></li>
</ul>
<h2 id="notify-関数">Notify 関数</h2>
<p>公式ドキュメントは https://pkg.go.dev/os/signal@go1.17.1#Notify にあります</p>
<p>プログラムがシグナルを受け取った際に指定したチャンネルに送るように設定する関数です。 チャンネルを必要十分なスペースがある必要があります。size が 1 であれば十分です。</p>
<p>第２引数のチャンネルを指定しなかった場合は、すべてのシグナルがチャンネルに流れるようになります。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>sigs <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> os<span class="op">.</span>Signal<span class="op">,</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>signal<span class="op">.</span>Notify<span class="op">(</span>sigs<span class="op">)</span> <span class="co">// すべてのシグナルが sigs に流れるようになる</span></span></code></pre></div>
<p>この関数は複数回呼び出し可能でその度に送信先のチャンネルが切り替わります。</p>
<p>以下がサンプルコードです。 (<a href="https://github.com/ayasuda/sandbox/blob/master/go/signal/multi_notify/main.go">github</a> にアップロード済み)</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;fmt&quot;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;os&quot;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;os/signal&quot;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    done <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">bool</span><span class="op">,</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    s1 <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> os<span class="op">.</span>Signal<span class="op">,</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    s2 <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> os<span class="op">.</span>Signal<span class="op">,</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;-</span>s1</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;got s1&quot;</span><span class="op">)</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        done <span class="op">&lt;-</span> <span class="ot">true</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;-</span>s2</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;got s2&quot;</span><span class="op">)</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        done <span class="op">&lt;-</span> <span class="ot">true</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    signal<span class="op">.</span>Notify<span class="op">(</span>s1<span class="op">,</span> os<span class="op">.</span>Interrupt<span class="op">)</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;-</span>done</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    signal<span class="op">.</span>Notify<span class="op">(</span>s2<span class="op">,</span> os<span class="op">.</span>Interrupt<span class="op">)</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;-</span>done</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>このプログラムは２回 SIGINT シグナルを受け取って終了するように作られており、 １回目は <code>s1</code> に、２回目は <code>s2</code> にシグナルが送られます。</p>
<h1 id="os.signal-パッケージ">os.Signal パッケージ</h1>
<p>Go 言語でのシグナル制御については、組み込みパッケージの <a href="https://pkg.go.dev/os/signal">os/signal</a> ドキュメントが一番詳しく纏まっています。</p>
<p>デフォルトでは各種非同期シグナルはランタイムパニックに変換されます。 具体的には以下のとおりです。</p>
<ul>
<li>SIGHUP, SIGINT, SIGTERM はプログラムの実行を終了します</li>
<li>SIGQUIT, SIGILL, SIGTRAP, SIGABRT, SIGSTKFLT, SIGEMT, SIGSYS はスタックをダンプしつつプログラムを終了します</li>
<li>SIGTSTP, SIGTTIN, SIGTTOU はシステムに定義されているデフォルトの振る舞いをします</li>
<li>SIGPROF は Go ランタイムに直接実装されている runtime.CPUPRofile によって処理されます</li>
<li>それ以外のシグナルは無視されます</li>
</ul>
<p>さて、 os/signal パッケージを使うことで、これらの挙動を変更することが可能です。 具体的には先に説明した <code>Notify</code> 関数を使うことで指定したチャンネルにシグナルを渡すように設定することができます。</p>
<p>また、Notify で設定した各種チャンネルの登録は、 os/signal パッケージの他の関数を使うことで適宜動作を変更可能です。</p>
<p>以下、 各種関数についてサンプルコードとともに動きを見ていきましょう</p>
<h2 id="ignore">Ignore</h2>
<p><code>Ignore</code> を使うことで、プログラムの実行中に特定のシグナルを無視させられます。 以下は、 SIGINT を開始後10秒間無視させるプログラム (<a href="https://github.com/ayasuda/sandbox/blob/master/go/signal/ignore/main.go">github</a>) です。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;fmt&quot;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;os&quot;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;os/signal&quot;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;time&quot;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 復帰できるように 10 秒タイマーを作っておきます。</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    t <span class="op">:=</span> time<span class="op">.</span>NewTimer<span class="op">(</span><span class="dv">10</span> <span class="op">*</span> time<span class="op">.</span>Second<span class="op">)</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    sigs <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> os<span class="op">.</span>Signal<span class="op">,</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;ignore Ctrl + C&quot;</span><span class="op">)</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Ignonre を呼び出し、 Ctrl + C を無視させます</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    signal<span class="op">.</span>Ignore<span class="op">(</span>os<span class="op">.</span>Interrupt<span class="op">)</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 10 秒経過後、Ctrl + C を受け取れるようにします</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;-</span>t<span class="op">.</span>C</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        t<span class="op">.</span>Stop<span class="op">()</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;start to accept Ctrl + c&quot;</span><span class="op">)</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        signal<span class="op">.</span>Notify<span class="op">(</span>sigs<span class="op">,</span> os<span class="op">.</span>Interrupt<span class="op">)</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;-</span>sigs</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;bye&quot;</span><span class="op">)</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>実行すると、10秒間は何も操作できません</p>
<pre><code>$ go run main.go
ignore Ctrl + C</code></pre>
<p>10 秒経つと <code>Ctrl + C</code> が入力可能になり、入力すると、 “bye” と表示してプログラムが終了します</p>
<pre><code>start to accept Ctrl + c
^Cbye</code></pre>
<h2 id="ignored">Ignored</h2>
<p>特定のシグナルが <code>Ignore</code> で無視されるように設定されているかを確認する関数です。 (<a href="https://github.com/ayasuda/sandbox/blob/master/go/signal/ignored/main.go">github</a>)</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;fmt&quot;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;os&quot;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;os/signal&quot;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;time&quot;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    tm <span class="op">:=</span> time<span class="op">.</span>NewTimer<span class="op">(</span><span class="dv">10</span> <span class="op">*</span> time<span class="op">.</span>Second<span class="op">)</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    ti <span class="op">:=</span> time<span class="op">.</span>NewTicker<span class="op">(</span><span class="dv">1</span> <span class="op">*</span> time<span class="op">.</span>Second<span class="op">)</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    sigs <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> os<span class="op">.</span>Signal<span class="op">,</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;ignore Ctrl + C&quot;</span><span class="op">)</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    signal<span class="op">.</span>Ignore<span class="op">(</span>os<span class="op">.</span>Interrupt<span class="op">)</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> <span class="op">{</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;-</span>ti<span class="op">.</span>C</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> signal<span class="op">.</span>Ignored<span class="op">(</span>os<span class="op">.</span>Interrupt<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>                fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;ignoring Ctrl + C&quot;</span><span class="op">)</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>                fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;wait Ctrl + C&quot;</span><span class="op">)</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;-</span>tm<span class="op">.</span>C</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>        tm<span class="op">.</span>Stop<span class="op">()</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;start to accept Ctrl + c&quot;</span><span class="op">)</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        signal<span class="op">.</span>Notify<span class="op">(</span>sigs<span class="op">,</span> os<span class="op">.</span>Interrupt<span class="op">)</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;-</span>sigs</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    ti<span class="op">.</span>Stop<span class="op">()</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;bye&quot;</span><span class="op">)</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>実行すると、1秒ごとに Ctrl + C が受付可能か表示されます 10 秒経つと <code>Ctrl + C</code> が入力可能になり、入力すると、 “bye” と表示してプログラムが終了します</p>
<pre><code>$ go run main.go
ignore Ctrl + C
ignoring Ctrl + C
ignoring Ctrl + C
ignoring Ctrl + C
ignoring Ctrl + C
ignoring Ctrl + C
ignoring Ctrl + C
ignoring Ctrl + C
ignoring Ctrl + C
ignoring Ctrl + C
ignoring Ctrl + C
start to accept Ctrl + c
wait Ctrl + C
wait Ctrl + C
wait Ctrl + C
^Cbye</code></pre>
<h2 id="notifycontext">NotifyContext</h2>
<p>公式ドキュメントは https://pkg.go.dev/os/signal@go1.17.1#NotifyContext にあります</p>
<p>Context そのものの説明については <a href="/pages/what_is_context_at_go.html">Context についての記事</a> を読んでもらうとして、 Go 言語の世界では外部プロセスの起動や API 呼び出しなど、並行に行いたい処理を実施する際には <code>Context</code> を 呼び出し元から呼び出し先に渡してやるのが一つのお約束となっていました。 そのようにすることで、タイムアウトや呼び出し元からのキャンセル処理などが書きやすくなっていました。</p>
<p>さて、呼び出し元からのキャンセルとしてあり得るのが、そもそものプログラムが <em>シグナル受信によって終了</em> するケースです。</p>
<p>Go 1.15 まではこれらの処理を手作業で書いていましたが、 Go 1.16 からは <code>NotifyContext</code> が追加され、処理をきれいに書けるようになりました。</p>
<p><code>NotifyContext</code> では親となる Context と受け取るシグナルを引数とし、子となる Context と 停止用関数が返されます。</p>
<p>この子となる <code>Context</code> の <code>Done()</code> チャンネルが閉じられるのは以下の３通りです</p>
<ol type="1">
<li><code>NotifyContext</code> で指定したシグナルを受信した時</li>
<li><code>NotifyContext</code> が返す <code>stop</code> 関数が直接呼び出された時</li>
<li><code>NotifyContext</code> に渡す親コンテストの <code>Done</code> チャンネルが閉じられる時</li>
</ol>
<p>サンプルで説明しましょう</p>
<p>以下のサンプルは、４つの方法で終了するプログラムです (<a href="https://github.com/ayasuda/sandbox/blob/master/go/signal/notify_context/main.go">github</a>)</p>
<ol type="1">
<li>開始から 10 秒経つと、自動的に終了します</li>
<li><code>Ctrl + C</code> を入力すると、 <code>ctx</code> の <code>Done()</code> チャンネルが閉じられ、終了します</li>
<li><code>exit</code> と入力すると、 <code>stop()</code> が呼び出されることにより <code>ctx</code> の <code>Done()</code> チャンネルが閉じられ終了します</li>
<li><code>cancel</code> と入力すると <code>parent</code> コンテキストがキャンセルされ (<code>cancel()</code> が呼び出され) ることにより <code>ctx</code> の <code>Done()</code> チャンネルが閉じられ終了します</li>
</ol>
<div class="sourceCode" id="cb12"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;context&quot;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;fmt&quot;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;os&quot;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;os/signal&quot;</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;time&quot;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    parent<span class="op">,</span> cancel <span class="op">:=</span> context<span class="op">.</span>WithCancel<span class="op">(</span>context<span class="op">.</span>Background<span class="op">())</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    ctx<span class="op">,</span> stop <span class="op">:=</span> signal<span class="op">.</span>NotifyContext<span class="op">(</span>parent<span class="op">,</span> os<span class="op">.</span>Interrupt<span class="op">)</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">defer</span> stop<span class="op">()</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">go</span> <span class="kw">func</span><span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 親から context 受け取ってるけど特にすることないので無視</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 本当は 親 context が終了した時の処理書いたほうがいいです</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> <span class="op">{</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>            <span class="kw">var</span> in <span class="dt">string</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>            fmt<span class="op">.</span>Scanln<span class="op">(&amp;</span>in<span class="op">)</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>            fmt<span class="op">.</span>Println<span class="op">(</span>in<span class="op">)</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>            <span class="kw">switch</span> in <span class="op">{</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">case</span> <span class="st">&quot;cancel&quot;</span><span class="op">:</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>                fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;canceled&quot;</span><span class="op">)</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>                cancel<span class="op">()</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>            <span class="kw">case</span> <span class="st">&quot;exit&quot;</span><span class="op">:</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>                fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;exited&quot;</span><span class="op">)</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>                stop<span class="op">()</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>            <span class="kw">default</span><span class="op">:</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>                fmt<span class="op">.</span>Println<span class="op">(</span>in<span class="op">)</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}(</span>ctx<span class="op">)</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">select</span> <span class="op">{</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> <span class="op">&lt;-</span>time<span class="op">.</span>After<span class="op">(</span><span class="dv">10</span> <span class="op">*</span> time<span class="op">.</span>Second<span class="op">):</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>        fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;time out&quot;</span><span class="op">)</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> <span class="op">&lt;-</span>ctx<span class="op">.</span>Done<span class="op">():</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>        stop<span class="op">()</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>        fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;interuppted&quot;</span><span class="op">)</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="reset">Reset</h2>
<p>公式ドキュメントは https://pkg.go.dev/os/signal@go1.17.1#Reset にあります</p>
<p><code>Notify</code> で設定したシグナル受信設定を解除する関数です。 第１引数を省略すると、プログラム中で設定した全てのシグナル受信が解除されます。</p>
<p>解除されたシグナルが送られてきた場合には、上記の方に記した「デフォルトの挙動」通りの動作となります。</p>
<p>下に示した例 (<a href="https://github.com/ayasuda/sandbox/blob/master/go/signal/reset/main.go">github</a>) は、本ページ上部に記載した基本例を修正し、 <code>Ctrl + C</code> を受け取らないようにしたものです。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;fmt&quot;</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;os&quot;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;os/signal&quot;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;time&quot;</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    ticker <span class="op">:=</span> time<span class="op">.</span>NewTicker<span class="op">(</span><span class="dv">1</span> <span class="op">*</span> time<span class="op">.</span>Second<span class="op">)</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    done <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">bool</span><span class="op">,</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    sigs <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> os<span class="op">.</span>Signal<span class="op">,</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// プログラムが Ctrl + C を受信した際に、チャンネルに通知するように設定する</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    signal<span class="op">.</span>Notify<span class="op">(</span>sigs<span class="op">,</span> os<span class="op">.</span>Interrupt<span class="op">)</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    cnt <span class="op">:=</span> <span class="dv">0</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> <span class="op">{</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;-</span>ticker<span class="op">.</span>C</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>            cnt <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>            fmt<span class="op">.</span>Println<span class="op">(</span>cnt<span class="op">)</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Ctrl + C をこのプログラムで処理しないようにする　</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    signal<span class="op">.</span>Reset<span class="op">(</span>os<span class="op">.</span>Interrupt<span class="op">)</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// sigs チャンネルが Ctrl + C を受信することがないので、以下のステップには到達しなくなります</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;-</span>sigs</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>        fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;bye&quot;</span><span class="op">)</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>        ticker<span class="op">.</span>Stop<span class="op">()</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>        done <span class="op">&lt;-</span> <span class="ot">true</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;-</span>done</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>このプログラムを実行することで、 <code>Ctrl + C</code> が入力された時に “bye” ではなく、go ランタイムデフォルトの表示がされるようになります。</p>
<pre><code>$ go run main.go
^Csignal: interrupt</code></pre>
<h2 id="stop">Stop</h2>
<p>公式ドキュメントは https://pkg.go.dev/os/signal@go1.17.1#Stop にあります</p>
<p><code>Reset</code> に似ていますが、こちら (<a href="https://github.com/ayasuda/sandbox/blob/master/go/signal/stop/main.go">github</a>) はチャンネルを指定して受信を停止する関数です。</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;fmt&quot;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;os&quot;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;os/signal&quot;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;time&quot;</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    ticker <span class="op">:=</span> time<span class="op">.</span>NewTicker<span class="op">(</span><span class="dv">1</span> <span class="op">*</span> time<span class="op">.</span>Second<span class="op">)</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    done <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">bool</span><span class="op">,</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    sigs <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> os<span class="op">.</span>Signal<span class="op">,</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    signal<span class="op">.</span>Notify<span class="op">(</span>sigs<span class="op">,</span> os<span class="op">.</span>Interrupt<span class="op">)</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    cnt <span class="op">:=</span> <span class="dv">0</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> <span class="op">{</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;-</span>ticker<span class="op">.</span>C</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>            cnt <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>            fmt<span class="op">.</span>Println<span class="op">(</span>cnt<span class="op">)</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// sigs チャンネルでシグナルを受信するのを停止する</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    signal<span class="op">.</span>Stop<span class="op">(</span>sigs<span class="op">)</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">// sigs チャンネルが Ctrl + C を受信することがないので、以下のステップには到達しなくなります</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;-</span>sigs</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>        fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;bye&quot;</span><span class="op">)</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>        ticker<span class="op">.</span>Stop<span class="op">()</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>        done <span class="op">&lt;-</span> <span class="ot">true</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;-</span>done</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>このプログラムを実行することで、 <code>Reset</code> と同じように <code>Ctrl + C</code> が入力された時に “bye” ではなく、go ランタイムデフォルトの表示がされるようになります。</p>
<pre><code>$ go run main.go
^Csignal: interrupt</code></pre>
</article>
<footer>
  <a href="/">Home</a>
</footer>
</body>
</html>
